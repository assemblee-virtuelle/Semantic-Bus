<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <title>Grappe</title>
  <!--<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, shrink-to-fit=no">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link href='https://fonts.googleapis.com/css?family=Ubuntu|Ubuntu+Mono' rel='stylesheet' type='text/css'>
  <link href='https://cdn.jsdelivr.net/semantic-ui/2.1.8/semantic.min.css' rel='stylesheet' type='text/css'>-->
  <link href='./css/flex.css' rel='stylesheet' type='text/css'>
  <link href='./css/main.css' rel='stylesheet' type='text/css'>
  <link href='./css/inputs.css' rel='stylesheet' type='text/css'>
  <link href='./js/jsonEditor/dist/jsoneditor.min.css' rel='stylesheet' type='text/css'>
  <link href="./image/grappe-log-01.png" rel="icon" type="image/png">
  <link rel="stylesheet" href="./js/awesomplete-gh-pages/awesomplete.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flexboxgrid/6.3.1/flexboxgrid.min.css" type="text/css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.5/themes/default/style.min.css" />
</head>

<body>
  <navigation></navigation>
  <script src="https://cdn.jsdelivr.net/npm/riot@3.7.0/riot+compiler.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/riot-route@3.1.2/dist/route+tag.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.0.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/webstomp-client@1.2.0/dist/webstomp.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.1.4/sockjs.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.5/jstree.min.js"></script>

  <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>-->
  <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/javascript-detect-element-resize/0.5.3/detect-element-resize.js"></script>-->



  <script src="./js/jsonEditor/dist/jsoneditor.min.js"></script>
  <script src="./js/pyrsmk-W/lib/W.min.js"></script>
  <script src="./js/sift/sift.min.js"></script>
  <script src="./js/jszip/dist/jszip.js"></script>
  <script src="./js/awesomplete-gh-pages/awesomplete.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.10.5/xlsx.min.js"></script>
  <script src="./js/spin.min.js"></script>
  <script src="./js/RiotControl/riotcontrol.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"></script>

  <script src="//d3js.org/d3-scale-chromatic.v0.3.min.js"></script>

  <script src="./store/workspaceBusiness.js"></script>
  <script src="./store/workspaceStore.js"></script>
  <script src="./store/bigdataflowStore.js"></script>
  <script src="./store/technicalComponentStore.js"></script>
  <script src="./store/genericStore.js"></script>
  <script src="./store/cacheNosqlStore.js"></script>
  <script src="./store/uploadFileStore.js"></script>
  <script src="./store/profilStore.js"></script>
  <script src="./store/mainController.js"></script>
  <script src="./store/sqlStore.js"></script>
  <script src="./store/utilStore.js"></script>

  <script type="riot/tag" src="tag/zenTable.tag"></script>
  <script type="riot/tag" src="tag/zenDate.tag"></script>
  <script type="riot/tag" src="tag/navigation.tag"></script>
  <script type="riot/tag" src="tag/workspaceTable.tag"></script>
  <script type="riot/tag" src="tag/workspaceTable-header.tag"></script>
  <script type="riot/tag" src="tag/workspaceShareTable.tag"></script>
  <script type="riot/tag" src="tag/workspaceShareTable-header.tag"></script>
  <script type="riot/tag" src="tag/workspaceEditor.tag"></script>
  <script type="riot/tag" src="tag/workspaceEditor-header.tag"></script>
  <script type="riot/tag" src="tag/workspaceComponentEditor.tag"></script>
  <script type="riot/tag" src="tag/workspaceComponentEditor-header.tag"></script>
  <script type="riot/tag" src="tag/technicalComponentTable.tag"></script>
  <script type="riot/tag" src="tag/jsonEditor.tag"></script>
  <script type="riot/tag" src="tag/jsonFragViewer.tag"></script>
  <script type="riot/tag" src="tag/user-list.tag"></script>
  <script type="riot/tag" src="tag/login.tag"></script>
  <script type="riot/tag" src="tag/profil.tag"></script>
  <script type="riot/tag" src="tag/profil-header.tag"></script>
  <script type="riot/tag" src="tag/graph.tag"></script>
  <script type="riot/tag" src="tag/graph_of_use.tag"></script>
  <script type="riot/tag" src="tag/share-workspace.tag"></script>
  <script type="riot/tag" src="tag/graph_of_use_workspace.tag"></script>
  <script type="riot/tag" src="tag/jsonPreviewer.tag"></script>
  <script type="riot/tag" src="tag/jsonPreviewer-header.tag"></script>
  <script type="riot/tag" src="tag/process-list.tag"></script>
  <script type="riot/tag" src="tag/no-editor.tag"></script>
  <script type="riot/tag" src="tag/xml-property-to-object-editor.tag"></script>
  <script type="riot/tag" src="tag/data-gouv-geolocaliser-mass-editor.tag"></script>
  <script type="riot/tag" src="tag/workspace/workspace-zen-table.tag"></script>
  <script type="riot/tag" src="tag/bigdataflow-table.tag"></script>
  <script type="riot/tag" src="tag/bigdataflow-table-header.tag"></script>
  <script type="riot/tag" src="tag/bigdataflow-editor.tag"></script>
  <script type="riot/tag" src="tag/bigdataflow-editor-header.tag"></script>


  <script type="riot/tag" src="tag/editorComponents/aggregation/simple-agregator-editor.tag"></script>
  <script type="riot/tag" src="tag/editorComponents/aggregation/join-by-field-editor.tag"></script>
  <script type="riot/tag" src="tag/editorComponents/aggregation/unicity-editor.tag"></script>

  <script type="riot/tag" src="tag/editorComponents/bdd/sql-connecteur-editor.tag"></script>
  <script type="riot/tag" src="tag/editorComponents/bdd/mongo-connecteur-editor.tag"></script>

  <script type="riot/tag" src="tag/editorComponents/cache/cache-nosql-editor.tag"></script>

  <script type="riot/tag" src="tag/editorComponents/dataFlow/rest-api-get-editor.tag"></script>
  <script type="riot/tag" src="tag/editorComponents/dataFlow/rest-get-json-editor.tag"></script>
  <script type="riot/tag" src="tag/editorComponents/dataFlow/framacalc-get-csv-editor.tag"></script>
  <script type="riot/tag" src="tag/editorComponents/dataFlow/google-get-json-editor.tag"></script>
  <script type="riot/tag" src="tag/editorComponents/dataFlow/rest-api-post-editor.tag"></script>
  <script type="riot/tag" src="tag/editorComponents/dataFlow/post-consumer-editor.tag"></script>

  <script type="riot/tag" src="tag/editorComponents/files/upload-editor.tag"></script>
  <script type="riot/tag" src="tag/editorComponents/files/rest-get-editor.tag"></script>
  <script type="riot/tag" src="tag/editorComponents/files/sftp-consumer-editor.tag"></script>

  <script type="riot/tag" src="tag/editorComponents/geocodage/google-geolocaliser-editor.tag"></script>
  <script type="riot/tag" src="tag/editorComponents/geocodage/data-gouv-inverse-geolocaliser-editor.tag"></script>
  <script type="riot/tag" src="tag/editorComponents/geocodage/data-gouv-geolocaliser-editor.tag"></script>

  <script type="riot/tag" src="tag/editorComponents/scrapper/scrapper-editor.tag"></script>

  <script type="riot/tag" src="tag/editorComponents/transformation/object-transformer.tag"></script>
  <script type="riot/tag" src="tag/editorComponents/transformation/filter-editor.tag"></script>
  <script type="riot/tag" src="tag/editorComponents/transformation/key-to-array-editor.tag"></script>
  <script type="riot/tag" src="tag/editorComponents/transformation/properties-matrix-editor.tag"></script>
  <script type="riot/tag" src="tag/editorComponents/transformation/sparql-request-editor.tag"></script>
  <script type="riot/tag" src="tag/editorComponents/transformation/value-mapping-editor.tag"></script>
  <script type="riot/tag" src="tag/editorComponents/transformation/value-from-path-editor.tag"></script>

  <script type="riot/tag" src="tag/editorComponents/utilities/deeper-focus-opening-bracket-editor.tag"></script>
  <script type="riot/tag" src="tag/editorComponents/utilities/timer-editor.tag"></script>
  <script type="riot/tag" src="tag/editorComponents/utilities/query-params-creation-editor.tag"></script>
  <script>
    $.ajax({
      method: 'get',
      url: '/configuration/frontend-configuration',
    }).done(configuration => {
      if (configuration.https == "force") {
        if (window.location.href.substr(0, 5) != "https") {
          window.location.replace("https" + window.location.href.substr(4, window.location.href.split("").length - 1))
        }
      }
      if (configuration.pk_stripe) localStorage.pk_stripe = configuration.pk_stripe
      if (configuration.privateScript) {
        configuration.privateScript.forEach((src) => {
          let a = document.createElement("script");
          /.[tag]+$/.test(src) ? a.type = "riot/tag" : a.type = "text/javascript";
          a.src = src
          document.body.appendChild(a);
        })
      } else {
        const x = document.createElement("script");
        x.type = "riot/tag";
        x.src = "tag/stripe-component.tag"
        document.body.appendChild(x);

        const y = document.createElement("script");
        y.type = "riot/tag";
        y.src = "tag/transactions-list.tag"
        document.body.appendChild(y);
      }




      var onConnect = (client) => {
        // no more r&d for private incrementation because
        // react refonte will change all this mechanisme
        const allStore = {};
        const utilStore = new UtilStore();
        RiotControl.addStore(utilStore);
        allStore['utilStore'] = utilStore;

        if (configuration.privateScript && configuration.privateScript.length > 0) {
          let stripeStore = new StripeStore(utilStore);
          RiotControl.addStore(stripeStore);
        }


        const profilStore = new ProfilStore(utilStore);
        RiotControl.addStore(profilStore);
        allStore['profilStore'] = profilStore;

        const technicalComponentStore = new TechnicalComponentStore(utilStore);
        RiotControl.addStore(technicalComponentStore);
        allStore['technicalComponentStore'] = technicalComponentStore;

        const specificStoreList = [];

        const cacheNosqlStore = new CacheNosqlStore(utilStore)
        RiotControl.addStore(cacheNosqlStore);
        specificStoreList.push(cacheNosqlStore)
        allStore['cacheNosqlStore'] = cacheNosqlStore;

        const uploadStore = new UploadStore(utilStore);
        RiotControl.addStore(uploadStore);
        specificStoreList.push(uploadStore)
        allStore['uploadStore'] = uploadStore;

        const sqlStore = new SqlStore();
        RiotControl.addStore(sqlStore);
        specificStoreList.push(sqlStore)
        allStore['sqlStore'] = sqlStore;

        const workspaceStore = new WorkspaceStore(utilStore, stompClientProxy, specificStoreList);
        RiotControl.addStore(workspaceStore);
        allStore['workspaceStore'] = workspaceStore;

        const bigdataflowStore = new BigdataflowStore(utilStore, stompClientProxy, specificStoreList);
        RiotControl.addStore(bigdataflowStore);
        allStore['bigdataflowStore'] = bigdataflowStore;

        const mainController = new MainController(allStore, stompClientProxy, utilStore);
        RiotControl.addStore(mainController);

        RiotControl.on('login_redirect', function() {
          window.open("../ihm/login.html", "_self");
        })

        riot.compile(function() {
          riot.mount('*');
        });
      };

      const login = 'guest';
      const password = 'guest';
      const stompClient = webstomp.client(configuration.url, {
        heartbeat: {
          incoming: 10000,
          outgoing: 10000
        },
        debug: true
      })


      const objectHandler = {
        get: function(target, propKey, receiver) {
          //I only want to intercept method calls, not property access
          var propValue = target[propKey];
          if (typeof propValue != "function") {
            return propValue;
          } else {
            return function() {
              console.log("intercepting call to " + propKey + " in cat " + target.name);
              if (target.connected == false && propKey=="send") {
                alert('amqp seem disconnected, please refresh your browser');
              }
              return propValue.apply(this, arguments)
            }
          }
        }
      }


      let stompClientProxy = new Proxy(stompClient, objectHandler);

      if (configuration.host != undefined && configuration.host.length > 0) {
        stompClientProxy.connect(login, password, onConnect, null, configuration.host);
      } else {
        stompClientProxy.connect(login, password, onConnect, onError);
      }
    })
  </script>
  <style>
    /*  Modifier la police principal de Grappe  */
    body {
      font-family: Arial, Helvetica, "Liberation Sans", FreeSans, sans-serif;
    }
  </style>
</body>

</html>
