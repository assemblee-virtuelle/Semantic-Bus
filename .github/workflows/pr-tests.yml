name: Pull Request Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  quick-tests:
    name: Quick Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: |
        npm install
        cd engine && npm install
        cd ../tests/test_unitaires && npm install
        
    - name: Run linting
      run: npm run lint
      
    - name: Run unit tests
      run: |
        npm run test:unit
        npm run test:engine
        
    - name: Check for security vulnerabilities
      run: |
        cd engine && npm audit --audit-level moderate
        cd ../main && npm audit --audit-level moderate || true
        cd ../timer && npm audit --audit-level moderate || true
        cd ../core && npm audit --audit-level moderate || true

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm run install:all
      
    - name: Generate test coverage
      run: |
        npm run test:engine
        
    - name: Comment PR with test results
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // Read coverage summary if it exists
          let coverageComment = '## Test Results\n\n✅ All tests passed!\n\n';
          
          try {
            const coveragePath = path.join(process.cwd(), 'engine/coverage/coverage-summary.json');
            if (fs.existsSync(coveragePath)) {
              const coverage = JSON.parse(fs.readFileSync(coveragePath, 'utf8'));
              const total = coverage.total;
              
              coverageComment += `### Code Coverage\n\n`;
              coverageComment += `- **Lines**: ${total.lines.pct}%\n`;
              coverageComment += `- **Functions**: ${total.functions.pct}%\n`;
              coverageComment += `- **Branches**: ${total.branches.pct}%\n`;
              coverageComment += `- **Statements**: ${total.statements.pct}%\n\n`;
            }
          } catch (e) {
            console.log('Coverage file not found or invalid');
          }
          
          coverageComment += `### Next Steps\n`;
          coverageComment += `- Integration tests will run after merge\n`;
          coverageComment += `- E2E tests will run on develop/main branches\n`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: coverageComment
          });

  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        
    - name: Check for outdated dependencies
      run: |
        echo "Checking for outdated dependencies..."
        cd engine && npm outdated || true
        cd ../main && npm outdated || true
        cd ../timer && npm outdated || true
        cd ../core && npm outdated || true
        
    - name: Check package-lock.json changes
      run: |
        if git diff --name-only HEAD^ | grep -q package-lock.json; then
          echo "⚠️ package-lock.json has been modified"
          echo "Please ensure dependencies are properly reviewed"
        fi